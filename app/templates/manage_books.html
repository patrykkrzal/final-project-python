{% extends "base.html" %}

{% block content %}
<section class="hero">
  <h2>Zarządzaj książkami</h2>
  <p>Wybierz książkę po tytule i autorze, a następnie edytuj lub usuń. Wymagane zalogowanie.</p>
  <div id="manage-message" style="margin-top: 1rem; margin-bottom: 1rem; white-space: pre-wrap;"></div>
  <div id="manage-root"></div>
</section>
<script>
  const messageEl = document.getElementById('manage-message');

  function showMessage(text, type = 'info') {
    messageEl.textContent = text;
    messageEl.style.color = type === 'error' ? '#b00020' : '#006400';
    // Ukryj komunikat po 5 sekundach
    setTimeout(() => { messageEl.textContent = ''; }, 5000);
  }

  async function initManage() {
    const token = localStorage.getItem('access_token');
    const root = document.getElementById('manage-root');
    if (!token) {
      root.innerHTML = '<p>Musisz być zalogowany, aby zarządzać książkami.</p>';
      return;
    }
    root.innerHTML = '<p>Ładowanie listy książek...</p>';
    try {
      const res = await fetch('/books');
      const books = await res.json();
      if (!Array.isArray(books) || books.length === 0) {
        root.innerHTML = '<p style="color:#cbd5e1;">Brak książek.</p>';
        return;
      }
      root.innerHTML = '';
      const form = document.createElement('div');
      form.style.maxWidth = '600px';
      form.style.margin = '0 auto';

      const label = document.createElement('label');
      label.style.display = 'block';
      label.style.marginBottom = '12px';
      label.style.textAlign = 'left';
      label.textContent = 'Wybierz książkę:';

      const select = document.createElement('select');
      select.style.width = '100%';
      select.style.padding = '10px';
      select.style.border = '1px solid #334155';
      select.style.borderRadius = '8px';
      select.style.background = '#0b1324';
      select.style.color = '#e5e7eb';

      books.forEach(b => {
        const opt = document.createElement('option');
        opt.value = String(b.id);
        opt.textContent = `${b.title} — ${b.author}`;
        select.appendChild(opt);
      });

      const actions = document.createElement('div');
      actions.className = 'actions-bar';

      // Create inline edit form (title, author, year, description)
      const editForm = document.createElement('form');
      editForm.style.marginTop = '16px';
      editForm.style.display = 'none';

      const inputTitle = document.createElement('input');
      inputTitle.type = 'text';
      inputTitle.name = 'title';
      inputTitle.placeholder = 'Tytuł';
      inputTitle.style.display = 'block';
      inputTitle.style.width = '100%';
      inputTitle.style.marginBottom = '8px';

      const inputAuthor = document.createElement('input');
      inputAuthor.type = 'text';
      inputAuthor.name = 'author';
      inputAuthor.placeholder = 'Autor';
      inputAuthor.style.display = 'block';
      inputAuthor.style.width = '100%';
      inputAuthor.style.marginBottom = '8px';

      const inputYear = document.createElement('input');
      inputYear.type = 'number';
      inputYear.name = 'year';
      inputYear.placeholder = 'Rok';
      inputYear.style.display = 'block';
      inputYear.style.width = '100%';
      inputYear.style.marginBottom = '8px';

      const inputDesc = document.createElement('textarea');
      inputDesc.name = 'description';
      inputDesc.placeholder = 'Opis';
      inputDesc.style.display = 'block';
      inputDesc.style.width = '100%';
      inputDesc.style.marginBottom = '8px';

      const btnSave = document.createElement('button');
      btnSave.className = 'btn sm';
      btnSave.type = 'submit';
      btnSave.textContent = 'Zapisz zmiany';

      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn outline sm';
      btnCancel.type = 'button';
      btnCancel.textContent = 'Anuluj';
      btnCancel.style.marginLeft = '8px';

      editForm.appendChild(inputTitle);
      editForm.appendChild(inputAuthor);
      editForm.appendChild(inputYear);
      editForm.appendChild(inputDesc);
      editForm.appendChild(btnSave);
      editForm.appendChild(btnCancel);

      const btnEdit = document.createElement('a');
      btnEdit.className = 'btn outline sm';
      btnEdit.href = '#';
      btnEdit.textContent = 'Edytuj';
      btnEdit.onclick = (e) => {
        e.preventDefault();
        const id = select.value;
        const current = books.find(b => String(b.id) === id);
        if (!current) return;
        // Populate form and show it
        inputTitle.value = current.title || '';
        inputAuthor.value = current.author || '';
        inputYear.value = current.year ?? '';
        inputDesc.value = current.description || '';
        editForm.style.display = 'block';
      };

      // Save handler: submit PATCH to /books/{id}
      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = select.value;
        const current = books.find(b => String(b.id) === id);
        if (!current) return;
        const update = {};
        if (inputTitle.value !== current.title) update.title = inputTitle.value;
        if (inputAuthor.value !== current.author) update.author = inputAuthor.value;
        if (inputYear.value !== '' && Number(inputYear.value) !== current.year) update.year = Number(inputYear.value);
        if (inputDesc.value !== current.description) update.description = inputDesc.value;
        if (Object.keys(update).length === 0) {
          showMessage('Brak zmian do zapisania.');
          editForm.style.display = 'none';
          return;
        }
        try {
          const resp = await fetch(`/books/${id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(update)
          });
          if (!resp.ok) {
            const detail = await resp.json();
            showMessage('Błąd edycji: ' + JSON.stringify(detail), 'error');
            return;
          }
          const updated = await resp.json();
          const opt = Array.from(select.options).find(o => o.value === id);
          if (opt) opt.textContent = `${updated.title} — ${updated.author}`;
          Object.assign(current, updated);
          showMessage(`Książka "${updated.title}" została zaktualizowana!`);
          editForm.style.display = 'none';
        } catch (err) {
          showMessage('Błąd edycji: ' + err, 'error');
        }
      });

      btnCancel.onclick = (e) => {
        e.preventDefault();
        editForm.style.display = 'none';
      };

      const btnDelete = document.createElement('a');
      btnDelete.className = 'btn outline sm';
      btnDelete.href = '#';
      btnDelete.textContent = 'Usuń';
      btnDelete.onclick = async (e) => {
        e.preventDefault();
        const id = select.value;
        const current = books.find(b => String(b.id) === id);
        const bookTitle = current ? current.title : 'książka';

        if (!confirm(`Czy na pewno chcesz usunąć "${bookTitle}"?`)) return;

        try {
          const del = await fetch(`/books/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (del.status === 204) {
            const idx = books.findIndex(b => String(b.id) === id);
            if (idx >= 0) books.splice(idx, 1);
            const optIdx = Array.from(select.options).findIndex(o => o.value === id);
            if (optIdx >= 0) select.remove(optIdx);
            showMessage(`Książka "${bookTitle}" została usunięta!`);
            if (select.options.length === 0) {
              root.innerHTML = '<p style="color:#cbd5e1;">Brak książek.</p>';
            }
          } else {
            const detail = await del.json();
            showMessage('Błąd usuwania: ' + JSON.stringify(detail), 'error');
          }
        } catch (err) {
          showMessage('Błąd usuwania: ' + err, 'error');
        }
      };

      form.appendChild(label);
      form.appendChild(select);
      actions.appendChild(btnEdit);
      actions.appendChild(btnDelete);
      root.appendChild(form);
      root.appendChild(actions);
      root.appendChild(editForm);
    } catch (err) {
      root.innerHTML = '<p style="color:#b91c1c;">Błąd ładowania: ' + err + '</p>';
    }
  }
  initManage();
</script>
{% endblock %}
